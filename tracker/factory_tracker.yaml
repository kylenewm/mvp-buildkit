schema_version: "0.1"
build_id: "B01"
tracker_id: "T01"
updated_at: "2025-12-24"

meta:
  purpose: "V0 build plan executed via small, proof-driven steps. Commit targets a toy repo until stable."
  operating_rules:
    - "Use tmp/toy_repo as the ONLY commit target until S11 passes."
    - "Patch-only per step; touch only allowed_files."
    - "Proof commands required; if proof fails, revert and fix before moving on."
    - "No plan parsing; treat plan artifact as verbatim input."

globals:
  canonical_paths:
    - "spec/spec.yaml"
    - "tracker/factory_tracker.yaml"
    - "invariants/invariants.md"
    - ".cursor/rules/00_global.md"
    - ".cursor/rules/10_invariants.md"
    - "prompts/step_template.md"
    - "prompts/review_template.md"
    - "prompts/patch_template.md"
    - "prompts/chair_synthesis_template.md"
    - "docs/ARTIFACT_REGISTRY.md"
  forbidden_paths:
    - "tracker/tracker.yaml"
    - "prompts/hotfix_sync.md"
    - "docs/build_guide.md"

steps:
  - id: S00
    title: "Create toy repo target (ignored)"
    intent: "Create an internal scratch git repo for safe commit testing."
    deliverables:
      - "tmp/toy_repo/ is a git repo with an initial commit"
      - "tmp/toy_repo is ignored by main repo"
    allowed_files:
      - ".gitignore"
      - "tmp/toy_repo/**"
    acceptance:
      - "tmp/toy_repo exists and has clean git status"
      - "main repo does not track tmp/toy_repo"
    proof:
      - "mkdir -p tmp/toy_repo && cd tmp/toy_repo && git init"
      - "echo '# toy repo' > README.md"
      - "git add README.md && git commit -m 'init toy repo'"
      - "cd ../.."
      - "git status --porcelain"
      - "test -n \"$(git check-ignore -n tmp/toy_repo || true)\""

  - id: S01
    title: "Commit safety rails (dirty repo + allowlist + additive-only)"
    intent: "Prevent overwrites/drift by enforcing strict write rules."
    deliverables:
      - "council commit fails if target repo dirty"
      - "council commit fails if any write path is outside allowlist"
      - "council commit fails if canonical dest already exists (additive-only for now)"
      - "manifest written only under versions/<ts>_<run_id>/"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/repo_writer.py"
      - "src/agentic_mvp_factory/repo.py"
    acceptance:
      - "Commit cannot overwrite or write non-canonical paths"
      - "Error messages list offending paths"
    proof:
      - "git -C tmp/toy_repo status --porcelain"
      - "council commit <run_id> --repo tmp/toy_repo || true"
      - "echo x >> tmp/toy_repo/README.md"
      - "council commit <run_id> --repo tmp/toy_repo || true"

  - id: S02
    title: "Registry-driven allowlist (single source of truth)"
    intent: "Make canonical paths explicit and referenced by commit validation."
    deliverables:
      - "docs/ARTIFACT_REGISTRY.md lists canonical + generated + forbidden"
      - "commit validation references this registry (or an internal equivalent mapping)"
    allowed_files:
      - "docs/ARTIFACT_REGISTRY.md"
      - "src/agentic_mvp_factory/repo_writer.py"
    acceptance:
      - "Registry is authoritative; drift triggers failure"
    proof:
      - "cat docs/ARTIFACT_REGISTRY.md | sed -n '1,120p'"
      - "council commit <run_id> --repo tmp/toy_repo || true"

  - id: S03
    title: "Phase 0 integration: add --context to council run plan"
    intent: "Inject bounded context into plan drafts/critiques/chair."
    deliverables:
      - "council run plan supports --context <path>"
      - "context pack content included in prompts for draft + critique + chair"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/graph.py"
    acceptance:
      - "Providing --context changes stored prompt/packet artifacts to include context content"
    proof:
      - "council run plan --project <slug> --packet council/packets/plan_packet.md --context phase_0/context_pack_lite.md --models <m1>,<m2> --chair <m1>"
      - "council show <new_plan_run_id> --section packet"

  - id: S04
    title: "Spec Council: stabilize output artifact + YAML validation"
    intent: "Make spec council outputs reliable and commit-compatible."
    deliverables:
      - "final spec stored as kind=output (not custom kinds)"
      - "chair output YAML validated (safe_load + required keys)"
      - "no fenced-code formatting passed into chair that encourages fences"
    allowed_files:
      - "src/agentic_mvp_factory/phase2/spec_council.py"
    acceptance:
      - "Spec council run ends waiting_for_approval and output is valid YAML"
    proof:
      - "council run spec --from-plan <approved_plan_run_id> --project <slug> --models <m1>,<m2> --chair <m1>"
      - "council show <spec_run_id> --section outputs"

  - id: S05
    title: "Commit supports spec runs (spec/spec.yaml only)"
    intent: "Commit writes only spec + snapshot + manifest for spec council."
    deliverables:
      - "spec/spec.yaml written into tmp/toy_repo"
      - "versions/<ts>_<run_id>/COMMIT_MANIFEST.md created"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/repo_writer.py"
      - "src/agentic_mvp_factory/repo.py"
    acceptance:
      - "Toy repo contains spec/spec.yaml and versions snapshot; nothing else added"
    proof:
      - "council approve <spec_run_id> --approve"
      - "council commit <spec_run_id> --repo tmp/toy_repo"
      - "tree -L 4 tmp/toy_repo"
      - "cat tmp/toy_repo/versions/*/COMMIT_MANIFEST.md"

  - id: S06
    title: "Phase 2: Tracker Council (tracker/factory_tracker.yaml)"
    intent: "Generate tracker YAML from approved plan (verbatim) with HITL."
    deliverables:
      - "council run tracker --from-plan <plan_run_id> works"
      - "final tracker stored as kind=output"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/phase2/tracker_council.py"
      - "src/agentic_mvp_factory/repo.py"
    acceptance:
      - "Tracker council produces valid YAML with steps and proofs"
    proof:
      - "council run tracker --from-plan <approved_plan_run_id> --project <slug> --models <m1>,<m2> --chair <m1>"
      - "council show <tracker_run_id> --section outputs"

  - id: S07
    title: "Commit supports tracker runs"
    intent: "Commit writes tracker/factory_tracker.yaml only + snapshot + manifest."
    deliverables:
      - "tracker/factory_tracker.yaml written into tmp/toy_repo"
      - "forbidden tracker/tracker.yaml never written"
    allowed_files:
      - "src/agentic_mvp_factory/repo_writer.py"
      - "src/agentic_mvp_factory/cli.py"
    acceptance:
      - "Toy repo has tracker/factory_tracker.yaml"
      - "Toy repo does NOT have tracker/tracker.yaml"
    proof:
      - "council approve <tracker_run_id> --approve"
      - "council commit <tracker_run_id> --repo tmp/toy_repo"
      - "ls -la tmp/toy_repo/tracker"
      - "! test -f tmp/toy_repo/tracker/tracker.yaml"

  - id: S08
    title: "Phase 2: Prompts Council (4 templates)"
    intent: "Generate prompt templates as canonical files."
    deliverables:
      - "prompts/step_template.md"
      - "prompts/review_template.md"
      - "prompts/patch_template.md"
      - "prompts/chair_synthesis_template.md"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/phase2/prompts_council.py"
      - "src/agentic_mvp_factory/repo_writer.py"
    acceptance:
      - "Prompts council outputs include all 4 files (as outputs/manifest)"
    proof:
      - "council run prompts --from-plan <approved_plan_run_id> --project <slug> --models <m1>,<m2> --chair <m1>"
      - "council show <prompts_run_id> --section outputs"

  - id: S09
    title: "Commit supports prompts runs"
    intent: "Commit writes only the 4 prompt templates + snapshot + manifest."
    deliverables:
      - "prompts/*.md written into tmp/toy_repo"
    allowed_files:
      - "src/agentic_mvp_factory/repo_writer.py"
      - "src/agentic_mvp_factory/cli.py"
    acceptance:
      - "Toy repo has exactly the 4 prompt templates (no extras)"
    proof:
      - "council approve <prompts_run_id> --approve"
      - "council commit <prompts_run_id> --repo tmp/toy_repo"
      - "ls -la tmp/toy_repo/prompts"
      - "tree -L 3 tmp/toy_repo/prompts"

  - id: S10
    title: "Phase 2: Cursor Rules Council (2 files)"
    intent: "Generate .cursor/rules files that reference invariants and enforce patch discipline."
    deliverables:
      - ".cursor/rules/00_global.md"
      - ".cursor/rules/10_invariants.md"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/phase2/cursor_rules_council.py"
      - "src/agentic_mvp_factory/repo_writer.py"
    acceptance:
      - "Rules do not duplicate invariants definitions; they reference invariants/invariants.md"
    proof:
      - "council run cursor-rules --from-plan <approved_plan_run_id> --project <slug> --models <m1>,<m2> --chair <m1>"
      - "council show <rules_run_id> --section outputs"

  - id: S11
    title: "Phase 2: Invariants Council (invariants/invariants.md)"
    intent: "Generate canonical invariants once; rules reference them."
    deliverables:
      - "invariants/invariants.md"
    allowed_files:
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/phase2/invariants_council.py"
      - "src/agentic_mvp_factory/repo_writer.py"
    acceptance:
      - "Invariants exist; include commit safety invariant (additive-only + dirty repo fail)"
    proof:
      - "council run invariants --from-plan <approved_plan_run_id> --project <slug> --models <m1>,<m2> --chair <m1>"
      - "council show <invariants_run_id> --section outputs"

  - id: S12
    title: "Commit supports full Phase 2 pack (multi-artifact commit)"
    intent: "One command writes the full canonical pack into tmp/toy_repo from the latest approved artifacts."
    deliverables:
      - "All canonical paths exist in tmp/toy_repo"
      - "Single snapshot folder contains manifest listing all files written"
    allowed_files:
      - "src/agentic_mvp_factory/repo_writer.py"
      - "src/agentic_mvp_factory/cli.py"
      - "src/agentic_mvp_factory/repo.py"
    acceptance:
      - "Toy repo has spec, tracker, invariants, rules, prompts, registry"
      - "Forbidden paths absent"
    proof:
      - "council commit pack --project <slug> --from-plan <approved_plan_run_id> --repo tmp/toy_repo"
      - "tree -L 5 tmp/toy_repo"
      - "! test -f tmp/toy_repo/tracker/tracker.yaml"
      - "! test -f tmp/toy_repo/prompts/hotfix_sync.md"

  - id: S13
    title: "Drift checker passes (canonical refs only)"
    intent: "Catch drift/deprecated references early and keep repo clean."
    deliverables:
      - "scripts/check_artifacts.py exits 0"
    allowed_files:
      - "scripts/check_artifacts.py"
      - "docs/ARTIFACT_REGISTRY.md"
    acceptance:
      - "No deprecated paths referenced by canonical files"
    proof:
      - "python scripts/check_artifacts.py"

  - id: S14
    title: "Toy end-to-end dogfood script"
    intent: "One repeatable command runs the whole chain into tmp/toy_repo."
    deliverables:
      - "scripts/toy_dogfood.sh"
    allowed_files:
      - "scripts/toy_dogfood.sh"
    acceptance:
      - "Script produces full pack in tmp/toy_repo"
    proof:
      - "bash scripts/toy_dogfood.sh"
      - "tree -L 5 tmp/toy_repo"
